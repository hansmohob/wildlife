# Create Image Registry (ECR)
aws ecr create-repository --repository-name wildlife/frontend 
aws ecr create-repository --repository-name wildlife/media
aws ecr create-repository --repository-name wildlife/data
aws ecr create-repository --repository-name wildlife/alerts

# Build Container Image (ECR)
cd /home/ec2-user/workspace/my-workspace/container-app
cd alerts
docker build -t wildlife/alerts .
cd ../data
docker build -t wildlife/data .
cd ../frontend
docker build -t wildlife/frontend .
cp /home/ec2-user/workspace/my-workspace/terraform/ignoreme.txt /home/ec2-user/workspace/my-workspace/container-app/media/dockerfile
cd ../media
docker build -t wildlife/media .
docker image ls | grep wildlife

# Push Container Image (ECR)
aws ecr get-login-password --region REPLACE_AWS_REGION | docker login --username AWS --password-stdin REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com
docker tag wildlife/alerts REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/alerts:latest
docker tag wildlife/data REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/data:latest
docker tag wildlife/frontend REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/frontend:latest
docker tag wildlife/media REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/media:latest
docker push REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/alerts:latest
docker push REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/data:latest
docker push REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/frontend:latest
docker push REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/media:latest

# Setup Networking (VPC)
aws ec2 create-vpc-endpoint --vpc-id REPLACE_VPC_ID --vpc-endpoint-type Interface --service-name com.amazonaws.REPLACE_AWS_REGION.ecr.api --subnet-ids REPLACE_PRIVATE_SUBNET_1 REPLACE_PRIVATE_SUBNET_2 --security-group-ids REPLACE_SECURITY_GROUP_APP --no-cli-pager
aws ec2 create-vpc-endpoint --vpc-id REPLACE_VPC_ID --vpc-endpoint-type Interface --service-name com.amazonaws.REPLACE_AWS_REGION.ecr.dkr --subnet-ids REPLACE_PRIVATE_SUBNET_1 REPLACE_PRIVATE_SUBNET_2 --security-group-ids REPLACE_SECURITY_GROUP_APP --no-cli-pager

# Deploy Cluster (ECS)
USERDATA=$(base64 -w 0 /home/ec2-user/workspace/my-workspace/workshop/ec2_user_data.sh)
ECS_AMI_ID=$(aws ssm get-parameters --names /aws/service/ecs/optimized-ami/amazon-linux-2/arm64/recommended/image_id --query "Parameters[0].Value" --output text)

aws ec2 create-launch-template \
    --launch-template-name REPLACE_PREFIX_CODE-launchtemplate-ecs \
    --version-description 1 \
    --launch-template-data "{
        \"ImageId\": \"$ECS_AMI_ID\",
        \"InstanceType\": \"t4g.medium\",
        \"UserData\": \"$USERDATA\",
        \"IamInstanceProfile\": {
            \"Name\": \"REPLACE_PREFIX_CODE-iamprofile-ecs\"
        },
        \"SecurityGroupIds\": [\"REPLACE_SECURITY_GROUP_APP\"],
        \"KeyName\": \"REPLACE_PREFIX_CODE-ec2-keypair\"
    }"

aws autoscaling create-auto-scaling-group \
    --auto-scaling-group-name REPLACE_PREFIX_CODE-asg-ecs \
    --launch-template LaunchTemplateName=REPLACE_PREFIX_CODE-launchtemplate-ecs \
    --min-size 2 \
    --max-size 4 \
    --desired-capacity 2 \
    --vpc-zone-identifier "REPLACE_PRIVATE_SUBNET_1,REPLACE_PRIVATE_SUBNET_2" \
    --tags ResourceId=REPLACE_PREFIX_CODE-asg-ecs,ResourceType=auto-scaling-group,Key=Name,Value=REPLACE_PREFIX_CODE-ecs-instance,PropagateAtLaunch=true

ASG_ARN=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names REPLACE_PREFIX_CODE-asg-ecs --query 'AutoScalingGroups[0].AutoScalingGroupARN' --output text)

aws ecs create-cluster \
    --cluster-name REPLACE_PREFIX_CODE-ecs \
    --service-connect-defaults namespace=wildlife \
    --no-cli-pager

aws ecs create-capacity-provider \
    --name REPLACE_PREFIX_CODE-capacity-ec2 \
    --auto-scaling-group-provider autoScalingGroupArn=$ASG_ARN,managedScaling='{status=ENABLED,targetCapacity=80}'

aws ecs put-cluster-capacity-providers \
    --cluster REPLACE_PREFIX_CODE-ecs \
    --capacity-providers FARGATE FARGATE_SPOT REPLACE_PREFIX_CODE-capacity-ec2 \
    --default-capacity-provider-strategy capacityProvider=FARGATE,weight=1 \
    --no-cli-pager

# Create Task Definition (ECS)
### Deploy to Fargate
aws ecs register-task-definition \
    --family wildlife-alerts-task \
    --requires-compatibilities FARGATE \
    --cpu 1024 \
    --memory 2048 \
    --runtime-platform operatingSystemFamily=LINUX,cpuArchitecture=ARM64 \
    --network-mode awsvpc \
    --execution-role-arn arn:aws:iam::REPLACE_AWS_ACCOUNT_ID:role/REPLACE_PREFIX_CODE-iamrole-ecstaskexecution \
    --no-cli-pager \
    --container-definitions '[
        {
            "name": "wildlife-alerts",
            "image": "REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/alerts:latest",
            "essential": true,
            "readonlyRootFilesystem": true,
            "portMappings": [
                {
                    "containerPort": 5000,
                    "protocol": "tcp",
                    "name": "alerts-http",
                    "appProtocol": "http"
                }
            ],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/aws/ecs/wildlife-alerts",
                    "awslogs-region": "REPLACE_AWS_REGION",
                    "awslogs-stream-prefix": "ecs"
                }
            }
        }
    ]'

### Deploy to EC2

aws ecs register-task-definition \
    --family wildlife-media-task \
    --requires-compatibilities EC2 \
    --cpu 1024 \
    --memory 2048 \
    --runtime-platform operatingSystemFamily=LINUX,cpuArchitecture=ARM64 \
    --network-mode awsvpc \
    --execution-role-arn arn:aws:iam::REPLACE_AWS_ACCOUNT_ID:role/REPLACE_PREFIX_CODE-iamrole-ecstaskexecution \
    --container-definitions '[
        {
            "name": "wildlife-media",
            "image": "REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/media:latest",
            "essential": true,
            "readonlyRootFilesystem": true,
            "portMappings": [
                {
                    "containerPort": 5000,
                    "protocol": "tcp",
                    "name": "media-http",
                    "appProtocol": "http"
                }
            ],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/aws/ecs/wildlife-media",
                    "awslogs-region": "REPLACE_AWS_REGION",
                    "awslogs-stream-prefix": "ecs"
                }
            }
        }
    ]'

### Deploy using JSON
aws ecs register-task-definition \
    --family wildlife-data-task \
    --requires-compatibilities FARGATE \
    --cpu 1024 \
    --memory 2048 \
    --runtime-platform operatingSystemFamily=LINUX,cpuArchitecture=ARM64 \
    --network-mode awsvpc \
    --execution-role-arn arn:aws:iam::REPLACE_AWS_ACCOUNT_ID:role/REPLACE_PREFIX_CODE-iamrole-ecstaskexecution \
    --container-definitions '[
        {
            "name": "wildlife-data",
            "image": "REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/data:latest",
            "essential": true,
            "readonlyRootFilesystem": false,
            "portMappings": [
                {
                    "containerPort": 27017,
                    "protocol": "tcp",
                    "name": "data-tcp",
                    "appProtocol": "http"
                }
            ],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/aws/ecs/wildlife-data",
                    "awslogs-region": "REPLACE_AWS_REGION",
                    "awslogs-stream-prefix": "ecs"
                }
            }
        }
    ]'

aws ecs register-task-definition \
    --family wildlife-frontend-task \
    --requires-compatibilities FARGATE \
    --cpu 1024 \
    --memory 2048 \
    --runtime-platform operatingSystemFamily=LINUX,cpuArchitecture=ARM64 \
    --network-mode awsvpc \
    --execution-role-arn arn:aws:iam::REPLACE_AWS_ACCOUNT_ID:role/REPLACE_PREFIX_CODE-iamrole-ecstaskexecution \
    --container-definitions '[
        {
            "name": "wildlife-frontend",
            "image": "REPLACE_AWS_ACCOUNT_ID.dkr.ecr.REPLACE_AWS_REGION.amazonaws.com/wildlife/frontend:latest",
            "essential": true,
            "readonlyRootFilesystem": true,
            "portMappings": [
                {
                    "containerPort": 5000,
                    "protocol": "tcp",
                    "name": "frontend-http",
                    "appProtocol": "http"
                }
            ],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/aws/ecs/wildlife-frontend",
                    "awslogs-region": "REPLACE_AWS_REGION",
                    "awslogs-stream-prefix": "ecs"
                }
            }
        }
    ]'

# Networking (ALB)
TG_ARN=$(aws elbv2 create-target-group --name REPLACE_PREFIX_CODE-targetgroup-ecs --protocol HTTP --port 5000 --vpc-id REPLACE_VPC_ID --target-type ip --health-check-path /wildlife --health-check-interval-seconds 30 --health-check-timeout-seconds 5 --healthy-threshold-count 2 --unhealthy-threshold-count 2 --ip-address-type ipv4 --output text --query 'TargetGroups[0].TargetGroupArn')
ALB_ARN=$(aws elbv2 create-load-balancer --name REPLACE_PREFIX_CODE-alb --subnets REPLACE_PUBLIC_SUBNET_1 REPLACE_PUBLIC_SUBNET_2 --security-groups REPLACE_SECURITY_GROUP_APP --scheme internet-facing --type application --output text --query 'LoadBalancers[0].LoadBalancerArn')
aws elbv2 create-listener --load-balancer-arn $ALB_ARN --protocol HTTP --port 80 --default-actions Type=forward,TargetGroupArn=$TG_ARN --no-cli-pager

# Create Services (ECS)
aws ecs create-service --cluster REPLACE_PREFIX_CODE-ecs --service-name wildlife-data --task-definition wildlife-data-task --desired-count 2 --launch-type FARGATE --network-configuration "awsvpcConfiguration={subnets=[REPLACE_PRIVATE_SUBNET_1,REPLACE_PRIVATE_SUBNET_2],securityGroups=[REPLACE_SECURITY_GROUP_APP],assignPublicIp=DISABLED}" --service-connect-configuration "enabled=true,namespace=wildlife,services=[{portName=data-tcp,discoveryName=wildlife-data,clientAliases=[{port=27017}]}]" --deployment-configuration "maximumPercent=200,minimumHealthyPercent=100" --no-cli-pager
aws ecs create-service --cluster REPLACE_PREFIX_CODE-ecs --service-name wildlife-frontend --task-definition wildlife-frontend-task --desired-count 2 --launch-type FARGATE --network-configuration "awsvpcConfiguration={subnets=[REPLACE_PRIVATE_SUBNET_1,REPLACE_PRIVATE_SUBNET_2],securityGroups=[REPLACE_SECURITY_GROUP_APP],assignPublicIp=DISABLED}" --service-connect-configuration "enabled=true,namespace=wildlife,services=[{portName=frontend-http,discoveryName=wildlife-frontend,clientAliases=[{port=5000}]}]" --load-balancers "targetGroupArn=$TG_ARN,containerName=wildlife-frontend,containerPort=5000" --deployment-configuration "maximumPercent=200,minimumHealthyPercent=100" --no-cli-pager
aws ecs create-service --cluster REPLACE_PREFIX_CODE-ecs --service-name wildlife-alerts --task-definition wildlife-alerts-task --desired-count 2 --launch-type FARGATE --network-configuration "awsvpcConfiguration={subnets=[REPLACE_PRIVATE_SUBNET_1,REPLACE_PRIVATE_SUBNET_2],securityGroups=[REPLACE_SECURITY_GROUP_APP],assignPublicIp=DISABLED}" --service-connect-configuration "enabled=true,namespace=wildlife,services=[{portName=alerts-http,discoveryName=wildlife-alerts,clientAliases=[{port=5000}]}]" --deployment-configuration "maximumPercent=200,minimumHealthyPercent=100" --no-cli-pager
aws ecs create-service --cluster REPLACE_PREFIX_CODE-ecs --service-name wildlife-media --task-definition wildlife-media-task --desired-count 2 --capacity-provider-strategy capacityProvider=REPLACE_PREFIX_CODE-capacity-ec2,weight=1 --network-configuration "awsvpcConfiguration={subnets=[REPLACE_PRIVATE_SUBNET_1,REPLACE_PRIVATE_SUBNET_2],securityGroups=[REPLACE_SECURITY_GROUP_APP],assignPublicIp=DISABLED}" --service-connect-configuration "enabled=true,namespace=wildlife,services=[{portName=media-http,discoveryName=wildlife-media,clientAliases=[{port=5000}]}]" --placement-constraints "type=distinctInstance" --deployment-configuration "maximumPercent=200,minimumHealthyPercent=100" --no-cli-pager
    

# Create Storage (S3)